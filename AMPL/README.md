# AMPL

# Adding BNFC

# Directory overview
`AMPL.cabal`
Cabal file used for building the program. 
Do not edit this file! It is automatically generated by `hpack` in `stack`.
Instead, if we need to add a dependency, edit the `package.yaml` file.

`LICENSE`
Default licence from a stack project..

`README.md`
Read me file. 

`Setup.hs`
Required for compiling -- generated by stack.

`hie.yaml`
Used for Haskell IDE engine (helps editing Haskell code).

`literature/`
Directory with relevant literature for the development of this project.
 - `literature/CMachine.pdf` contains all the theory behind this project.

`logs/`
Directory of logs made during execution of the machine.

`package.yaml`
A file used by stack (hpack) to generate the  `.cabal`. 
Edit this file to manage dependencies.

`app/`
Directory for a thin wrapper around AMPL code in `src/`
 - `app/Main.hs`
   - Mostly empty...
 - `app/InteractiveTests.hs`
   - Contains code of example programs for the machine and functions to run them.
 - `app/AMPL.hs` 
   - contains code which wraps other functions to run the machine.

`src/`
Directory containing Haskell source code for AMPL
 - `src/AMPLConcurrent.hs`
   - contains code for one concurrent step of the machine
 - `src/AMPLEnv.hs` 
   - contains code for the environment for which the machine runs in (e.g. program state)
 - `src/AMPLLogger.hs` 
   - contains code for a logging mechanism 
 - `src/AMPLMach.hs` 
   - contains code which actually runs the machine -- this includes channel manager loops, process loops, and TCP server loops.
 - `src/AMPLSequential.hs` 
   - contains for one sequential step of the machine
 - `src/AMPLServices.hs` 
   - contains code relevant to external services -- including opening TCP servers.
 - `src/AMPLTypes.hs` 
   - contains most of the types used in the program including: instructions for the queue, instructions for a sequential step, and instructions for a concurrent step.
 - `src/ServiceConstants.hs` 
   - contains the "magic" constants used by services to communicate properly between them
 - `src/Data/Queue.hs` 
   - is an implementation of a Queue based of Chris Okasaki's work
 - `src/Data/Stream.hs` 
   - is an implementation of a Stream (infinite list).

`stack.yaml`
File used by stack to help ensure reproducible builds.

`stack.yaml.lock`
Auto generated by stack.

`test/`
Directory contain Haskell source code for the automated testing of parts of the project.

# Architecture explanation...
This implementation uses the following:
  - Each process gets its own thread
  - The channel manager runs on its own thread
  - Processes communicate to the channel manager by putting commands on a *broadcast channel*
  - A *broadcast channel* is a thread safe queue which is read by the channel manager to see how it should be updated.

  - External services are managed by socket connections with a TCP server.
  - The TCP server runs on its own thread and is always polling for connections.
  - Given a connection, it does a "handshake" protocol to figure out which channel the connection corresponds to
  - If the "handshake" protocol succeeds, then a new thread is spawned to manage the connection.
